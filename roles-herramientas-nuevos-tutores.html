<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roles del tutor virtual — Drag & Drop</title>
  <style>
    :root{
      --azul:#2563eb; --azul-osc:#1e40af; --claro:#f1f5f9; --gris:#334155; --card:#e2e8f0; --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--claro);color:var(--gris)}
    header{padding:20px;display:flex;align-items:center;justify-content:space-between;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    header h1{margin:0;font-size:1.1rem;font-weight:700}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--azul);color:#fff}
    .btn-secondary{background:#fff;border:2px solid var(--azul);color:var(--azul)}
    .btn-ghost{background:transparent;border:0;color:var(--azul);text-decoration:underline}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .screen{max-width:1100px;margin:24px auto;padding:16px}
    .card{background:#fff;border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.06)}

    #startScreen{display:block}
    .start-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;padding:22px}
    label{font-weight:600;margin-bottom:8px;display:block}
    input[type="text"]{width:100%;padding:14px 12px;border-radius:12px;border:2px solid #cbd5e1;font-size:1rem}
    .hint{font-size:.9rem;color:#475569;margin-top:8px}
    .pill{display:inline-block;background:var(--azul);color:#fff;border-radius:999px;padding:6px 10px;font-weight:700;margin:6px 8px 0 0}

    #activity{display:none}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px}
    .bank,.sentences{background:#fff;border-radius:18px;padding:16px}
    .bank h3,.sentences h3{margin:0 0 10px}

    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{user-select:none;background:var(--azul);color:#fff;border-radius:14px;padding:10px 12px;font-weight:700;cursor:grab;box-shadow:0 6px 16px rgba(37,99,235,.25);-webkit-user-drag:element;touch-action:none}
    .chip:active{cursor:grabbing}
    .chip.selected{outline:3px solid #fbbf24; outline-offset:3px}
    .chip.dragging{position:fixed;left:0;top:0;transform:translate(var(--dx,0px), var(--dy,0px));z-index:9999;opacity:.95;pointer-events:none}

    .row{display:grid;grid-template-columns:1fr 180px;align-items:center;gap:12px;margin:12px 0;padding:10px;border-radius:14px;background:var(--card)}
    .bubble{background:#5b9cf3;color:#fff;border-radius:14px;padding:16px;font-weight:800;text-align:center;box-shadow:inset 0 -2px 0 rgba(0,0,0,.06)}

    .drop{background:#fff;border:2px dashed #94a3b8;border-radius:14px;min-height:52px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#64748b}
    .drop.hover{border-color:var(--azul)}
    .drop.filled{border-style:solid}

    .controls{display:flex;gap:10px;justify-content:flex-end;padding:14px}
    .score{padding:10px 14px;font-weight:700}

    dialog{border:0;border-radius:18px;padding:0;box-shadow:0 20px 50px rgba(0,0,0,.25);max-width:720px}
    .modal-body{padding:20px}
    .modal-header{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left}
    th{background:#f8fafc}

    @media (max-width: 900px){.layout{grid-template-columns:1fr}.row{grid-template-columns:1fr;gap:10px}}
  </style>
</head>
<body>
  <header>
    <h1>Actividad: Arrastra y suelta — Roles del tutor virtual</h1>
    <div>
      <button class="btn btn-secondary" id="btnShowScores1">Ver tabla de scores</button>
    </div>
  </header>

  <section id="startScreen" class="screen">
    <div class="card start-grid">
      <div>
        <h2>1) Ingresa tu <em>nickname</em></h2>
        <p>Debe ser <strong>un número</strong> (por ejemplo: 12345). Si no lo es, no podrás continuar.</p>
        <label for="nick">Nickname numérico</label>
        <input id="nick" type="text" inputmode="numeric" placeholder="Ej.: 2025001" autocomplete="off" />
        <p class="hint">Consejo: usa tu código o un número que puedas recordar.</p>
        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="startBtn" class="btn btn-primary">Comenzar actividad</button>
          <button id="clearScores" class="btn btn-ghost" title="Borrar datos guardados en este navegador">Borrar scores guardados</button>
        </div>
      </div>
      <div>
        <h2>2) ¿Cómo jugar?</h2>
        <p>Arrastra las palabras azules a los espacios a la derecha de cada frase. Luego presiona <b>Calificar</b> para ver tu puntaje.</p>
        <div>
          <span class="pill">Facilitador</span>
          <span class="pill">Comunicador</span>
          <span class="pill">Productor</span>
          <span class="pill">Innovador</span>
          <span class="pill">Community Manager</span>
          <span class="pill">Analista de datos</span>
        </div>
      </div>
    </div>
  </section>

  <section id="activity" class="screen">
    <div class="layout">
      <div class="bank card">
        <h3>Palabras</h3>
        <div id="bank" class="chips" aria-label="Banco de palabras"></div>
      </div>

      <div class="sentences card">
        <h3>Nuevos roles de los tutores</h3>
        <div class="row">
          <div class="bubble">Produce y edita los videos propios con una buena calidad</div>
          <div class="drop" data-accept="Productor" aria-label="Destino 1"></div>
        </div>
        <div class="row">
          <div class="bubble">Prepara buenos discursos utilizando los nuevos formatos como los audiovisuales</div>
          <div class="drop" data-accept="Comunicador" aria-label="Destino 2"></div>
        </div>
        <div class="row">
          <div class="bubble">Gestiona los foros y otras herramientas sociales</div>
          <div class="drop" data-accept="Community Manager" aria-label="Destino 3"></div>
        </div>
        <div class="row">
          <div class="bubble">Fomenta la autonomía del alumno</div>
          <div class="drop" data-accept="Facilitador" aria-label="Destino 4"></div>
        </div>
        <div class="row">
          <div class="bubble">Busca nuevas experiencias o intervenciones dentro del aula y fuera del aula</div>
          <div class="drop" data-accept="Innovador" aria-label="Destino 5"></div>
        </div>
        <div class="row">
          <div class="bubble">Analiza e interpreta la información para determinar qué funciona y qué no</div>
          <div class="drop" data-accept="Analista de datos" aria-label="Destino 6"></div>
        </div>
        <div class="controls">
          <span id="nicknameOut" class="score"></span>
          <span id="scoreOut" class="score"></span>
          <button id="btnGrade" class="btn btn-primary">Calificar</button>
          <button id="btnRetry" class="btn btn-secondary">Reintentar</button>
        </div>
      </div>
    </div>
  </section>

  <dialog id="scoresModal">
    <div class="modal-header">
      <strong>Tabla de scores (local)</strong>
      <button id="closeScores" class="btn">✕</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-bottom:10px">
        <button id="downloadJson" class="btn btn-secondary">Descargar JSON</button>
      </div>
      <div style="max-height:50vh;overflow:auto">
        <table id="scoresTable" aria-label="Tabla de scores">
          <thead><tr><th>Fecha</th><th>Nickname</th><th>Score</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </dialog>

  <script>
    // ===== State & helpers =====
    const WORDS = ["Facilitador","Comunicador","Productor","Innovador","Community Manager","Analista de datos"];
    const bank = document.getElementById('bank');
    const drops = () => Array.from(document.querySelectorAll('.drop'));
    let nickname = '';

    const isNumericNick = (v) => /^\d+$/.test((v||'').trim());
    const el = (tag, cls, text)=>{const e=document.createElement(tag); if(cls) e.className=cls; if(text) e.textContent=text; return e;};
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function nowISO(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}

    // ===== Scores =====
    const STORAGE_KEY='roles_tutor_scores_v1';
    const getScores=()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return []}};
    const saveScore=(entry)=>{const arr=getScores();arr.push(entry);localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));};
    const clearScores=()=>localStorage.removeItem(STORAGE_KEY);

    function openScores(){
      const modal=document.getElementById('scoresModal');
      const tbody=document.querySelector('#scoresTable tbody');
      tbody.innerHTML='';
      const rows=getScores();
      if(rows.length===0){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=3;td.textContent='Sin registros todavía.';tr.appendChild(td);tbody.appendChild(tr);} else {
        rows.forEach(r=>{const tr=document.createElement('tr');tr.appendChild(el('td',null,r.fecha));tr.appendChild(el('td',null,r.nickname));tr.appendChild(el('td',null,String(r.score)));tbody.appendChild(tr);});
      }
      modal.showModal();
    }
    function downloadScores(){const data=JSON.stringify(getScores(),null,2);const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='scores_roles_tutor.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}

    // ===== Rendering =====
    let selectedChip=null; let dragIdCounter=0; let peActive=false;
    function renderBank(){
      bank.innerHTML='';
      shuffle(WORDS.slice()).forEach(w=>{
        const chip=el('div','chip',w);
        chip.setAttribute('draggable','true');
        chip.dataset.role=w; chip.tabIndex=0;
        chip.addEventListener('dragstart', onDragStart);
        chip.addEventListener('dblclick',()=>bank.appendChild(chip));
        chip.addEventListener('click',()=>{if(selectedChip&&selectedChip!==chip)selectedChip.classList.remove('selected');selectedChip=(selectedChip===chip)?null:chip;chip.classList.toggle('selected');});
        enablePointerDrag(chip);
        bank.appendChild(chip);
      });
    }
    function clearDrops(){drops().forEach(d=>{d.classList.remove('filled');d.textContent='Suelta aquí';});}

    // ===== HTML5 Drag & Drop =====
    function onDragStart(ev){const id=`drag-${dragIdCounter++}`;ev.target.id=id;ev.dataTransfer.effectAllowed='move';try{ev.dataTransfer.setData('text/plain',id)}catch{}try{ev.dataTransfer.setData('text',id)}catch{}}
    function onDragOver(ev){ev.preventDefault();ev.dataTransfer.dropEffect='move';ev.currentTarget.classList.add('hover');}
    function onDragLeave(ev){ev.currentTarget.classList.remove('hover');}
    function placeChipInDrop(chip,dropEl){if(!chip||!dropEl)return;const existing=dropEl.querySelector('.chip');if(existing)bank.appendChild(existing);dropEl.innerHTML='';chip.classList.remove('dragging');chip.style.removeProperty('--dx');chip.style.removeProperty('--dy');dropEl.appendChild(chip);dropEl.classList.add('filled');}
    function onDrop(ev){ev.preventDefault();ev.currentTarget.classList.remove('hover');const id=ev.dataTransfer.getData('text/plain')||ev.dataTransfer.getData('text');const chip=document.getElementById(id);placeChipInDrop(chip,ev.currentTarget);}
    function enableDropzones(){
      drops().forEach(d=>{
        d.textContent='Suelta aquí'; d.addEventListener('dragover',onDragOver); d.addEventListener('dragleave',onDragLeave); d.addEventListener('drop',onDrop);
        d.addEventListener('click',()=>{if(selectedChip){placeChipInDrop(selectedChip,d);selectedChip.classList.remove('selected');selectedChip=null;}});
      });
      bank.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';});
      bank.addEventListener('drop',e=>{e.preventDefault();const id=e.dataTransfer.getData('text/plain')||e.dataTransfer.getData('text');const chip=document.getElementById(id);if(!chip)return;chip.classList.remove('dragging');bank.appendChild(chip);chip.classList.remove('selected');});
    }

    // ===== Pointer Events fallback =====
    function enablePointerDrag(chip){
      let startX=0,startY=0;
      function onPointerDown(e){if(e.button!==undefined&&e.button!==0)return;peActive=true;startX=e.clientX;startY=e.clientY;chip.classList.add('dragging');if(chip.setPointerCapture)chip.setPointerCapture(e.pointerId);e.preventDefault();}
      function onPointerMove(e){if(!peActive||!chip.classList.contains('dragging'))return;const dx=e.clientX-startX,dy=e.clientY-startY;chip.style.setProperty('--dx',dx+'px');chip.style.setProperty('--dy',dy+'px');}
      function onPointerUp(e){if(!peActive)return;peActive=false;if(chip.releasePointerCapture)chip.releasePointerCapture(e.pointerId);const els=document.elementsFromPoint(e.clientX,e.clientY);const targetDrop=els.find(el=>el.classList&&el.classList.contains('drop'));if(targetDrop){placeChipInDrop(chip,targetDrop);}else{chip.classList.remove('dragging');chip.style.removeProperty('--dx');chip.style.removeProperty('--dy');bank.appendChild(chip);}}
      chip.addEventListener('pointerdown',onPointerDown); chip.addEventListener('pointermove',onPointerMove); chip.addEventListener('pointerup',onPointerUp); chip.addEventListener('pointercancel',onPointerUp);
    }

    // ===== Activity control =====
    function grade(){
      let correct=0; drops().forEach(d=>{const expected=d.dataset.accept;const chip=d.querySelector('.chip');if(chip){const ok=chip.dataset.role===expected;d.style.borderColor=ok?'var(--ok)':'var(--err)';d.style.color=ok?'var(--ok)':'var(--err)';if(ok)correct++;}else{d.style.borderColor='var(--err)';d.style.color='var(--err)';}});
      document.getElementById('scoreOut').textContent=`Puntaje: ${correct} / 6`;
      document.getElementById('nicknameOut').textContent=`Nickname: ${nickname}`;
      saveScore({fecha:nowISO(),nickname,score:correct});
    }
    function retry(){document.getElementById('scoreOut').textContent='';document.getElementById('nicknameOut').textContent='';clearDrops();renderBank();}

    // ===== Screen flow =====
    function startActivity(){
      const v=document.getElementById('nick').value.trim();
      if(!isNumericNick(v)){alert('El nickname debe ser SOLO números. Intenta nuevamente.');document.getElementById('nick').focus();return;}
      nickname=v; document.getElementById('startScreen').style.display='none'; document.getElementById('activity').style.display='block'; renderBank(); enableDropzones();
    }

    // ===== Wire up =====
    document.getElementById('startBtn').addEventListener('click', startActivity);
    document.getElementById('btnGrade').addEventListener('click', grade);
    document.getElementById('btnRetry').addEventListener('click', retry);
    document.getElementById('btnShowScores1').addEventListener('click', openScores);
    document.getElementById('closeScores').addEventListener('click', ()=>document.getElementById('scoresModal').close());
    document.getElementById('downloadJson').addEventListener('click', downloadScores);
    document.getElementById('clearScores').addEventListener('click', ()=>{if(confirm('¿Borrar todos los scores guardados en este navegador?')){ clearScores(); alert('Listo.'); }});

    // ===== Minimal test cases (console) =====
    function runTests(){
      const results=[]; const expect=(name,cond)=>results.push({name,ok:!!cond});
      expect('isNumericNick("12345") true', isNumericNick('12345')===true);
      expect('isNumericNick("12a45") false', isNumericNick('12a45')===false);
      const expected=Array.from(document.querySelectorAll('.drop')).map(d=>d.dataset.accept);
      expect('6 dropzones', expected.length===6);
      expect('All labels present', ['Productor','Comunicador','Community Manager','Facilitador','Innovador','Analista de datos'].every(x=>expected.includes(x)));
      renderBank(); const bankWords=Array.from(document.querySelectorAll('#bank .chip')).map(c=>c.textContent.trim());
      expect('6 chips in bank', bankWords.length===6);
      expect('All words present in bank', ['Facilitador','Comunicador','Productor','Innovador','Community Manager','Analista de datos'].every(x=>bankWords.includes(x)));
      console.log('Test results:', results.map(r=>`${r.ok?'PASS':'FAIL'} - ${r.name}`));
    }
    runTests();
  </script>
</body>
</html>
