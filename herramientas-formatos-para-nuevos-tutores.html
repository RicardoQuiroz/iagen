<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Actividad Drag & Drop</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#fff; --muted:#6b7280; --text:#111827;
    --primary:#3b82f6; --primary-700:#2563eb;
    --ok:#16a34a; --bad:#dc2626; --ring:#c7d2fe;
    --chip-bg:#e0f2fe; --chip-bd:#7dd3fc;
    --drop-bg:#eef2ff; --drop-bd:#a5b4fc;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial; background:var(--bg); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center}
  .wrap{width:min(960px,92vw)}
  .card{background:var(--card); border-radius:1.25rem; padding:1.5rem; box-shadow:0 10px 25px rgba(0,0,0,.08)}
  h1{margin:.25rem 0 1rem; text-align:center; font-size:1.6rem}
  .row{margin:.75rem 0}
  input[type="number"]{width:100%; border:1px solid #d1d5db; border-radius:.75rem; padding:.8rem 1rem; font-size:1rem}
  .btn{width:100%; border:0; border-radius:.9rem; padding:.9rem 1rem; background:var(--primary); color:#fff; font-weight:700; cursor:pointer}
  .btn:hover{background:var(--primary-700)}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .sentence{line-height:2.2; font-size:1.05rem}
  .dropzone{
    display:inline-flex; align-items:center; justify-content:center;
    min-width:110px; min-height:40px; padding:.25rem .6rem; margin:0 .15rem .35rem;
    border:2px dashed var(--drop-bd); background:var(--drop-bg);
    color:var(--muted); border-radius:999px; vertical-align:middle;
    transition:box-shadow .15s;
    user-select:none;
  }
  .dropzone.filled{border-style:solid; color:var(--text); background:#fff}
  .dropzone.active{box-shadow:0 0 0 4px var(--ring)}
  .dropzone.correct{border-color:var(--ok)}
  .dropzone.incorrect{border-color:var(--bad)}
  #bank{display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.75rem}
  .chip{display:inline-flex; align-items:center; justify-content:center; padding:.45rem .8rem; border-radius:.8rem; border:1px solid var(--chip-bd); background:var(--chip-bg); cursor:grab; user-select:none; touch-action:none}
  .chip.selected{outline:3px solid var(--ring)}
  .ghost{position:fixed; pointer-events:none; transform:translate(-50%,-50%); z-index:9999}
  .actions{display:grid; gap:1rem; margin-top:1rem}
  table{width:100%; border-collapse:collapse; margin-top:.75rem}
  th,td{border:1px solid #e5e7eb; padding:.55rem .6rem; text-align:center}
  th{background:#f8fafc}
  .score{font-weight:700; text-align:center; margin-top:.75rem}
  #err{position:fixed; left:0; right:0; bottom:0; background:#fee2e2; color:#991b1b; padding:.5rem .75rem; font-size:.9rem; display:none}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <section id="login" class="card">
    <h1>Ingresa tu nickname numérico</h1>
    <p class="muted" style="text-align:center">Debe ser solo números (ej. 10234)</p>
    <div class="row"><input id="nick" type="number" inputmode="numeric" placeholder="Ej: 12345"/></div>
    <div class="row"><button class="btn" id="go" type="button">Comenzar</button></div>
    <noscript><p style="color:#b91c1c">Activa JavaScript para usar esta actividad.</p></noscript>
  </section>

  <!-- JUEGO -->
  <section id="game" class="card hidden" aria-live="polite">
    <h1>Completa las frases</h1>

    <p class="sentence">
      Es labor del profesor conseguir que el aprendizaje sea más
      <span class="dropzone" data-answer="personal">suelta aquí</span>
      y se adapte al
      <span class="dropzone" data-answer="ritmo">suelta aquí</span>
      y al
      <span class="dropzone" data-answer="estilo">suelta aquí</span>
      de cada alumno.
    </p>

    <p class="sentence">
      Una parte del contenido disponible en internet está además publicado con licencias
      <span class="dropzone" data-answer="abiertas">suelta aquí</span>,
      tales como Creative Commons o similar, por lo que es posible, no sólo
      <span class="dropzone" data-answer="acceder">suelta aquí</span>
      a los contenidos, sino también
      <span class="dropzone" data-answer="reutilizarlos">suelta aquí</span>
      y
      <span class="dropzone" data-answer="adaptarlos">suelta aquí</span>
      dentro del contexto de un curso.
    </p>

    <div id="bank" aria-label="Banco de palabras"></div>

    <div class="actions">
      <button id="check" class="btn" type="button">Revisar</button>
      <div id="result" class="score"></div>
      <button id="tableBtn" class="btn" type="button" style="background:#1f2937">Ver tabla de puntajes</button>
    </div>
  </section>

  <!-- TABLA -->
  <section id="scores" class="card hidden">
    <h1>Tabla de puntajes</h1>
    <table>
      <thead><tr><th>Nickname</th><th>Puntaje</th><th>Fecha</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="actions">
      <button id="dl" class="btn" type="button">Descargar JSON</button>
      <button id="back" class="btn" type="button" style="background:#1f2937">Volver</button>
    </div>
  </section>

</div>

<!-- Visor de errores -->
<div id="err"></div>

<script defer>
/* ===================== Helper de errores visibles ===================== */
(function(){
  const errBox = document.getElementById('err');
  const show = (msg)=>{ errBox.textContent = 'Error: ' + msg; errBox.style.display='block'; };
  window.addEventListener('error', e => show(e.message));
  window.addEventListener('unhandledrejection', e => show(String(e.reason)));
})();

/* ===================== LÓGICA ===================== */
(function(){
  const WORDS = ["abiertas","adaptarlos","personal","acceder","ritmo","reutilizarlos","estilo"];

  // utilidades
  function qs(s){ return document.querySelector(s); }
  function qsa(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }

  // elementos
  const $login = qs('#login');
  const $game = qs('#game');
  const $scores = qs('#scores');
  const $nick = qs('#nick');
  const $go = qs('#go');
  const $bank = qs('#bank');
  const $check = qs('#check');
  const $result = qs('#result');
  const $tableBtn = qs('#tableBtn');
  const $tbody = qs('#tbody');
  const $back = qs('#back');
  const $dl = qs('#dl');

  let currentUser = null;

  // ——— inicio seguro
  function startGame(){
    try{
      const v = ($nick.value || '').trim();
      if (!/^\d+$/.test(v)) { alert('Ingresa sólo números.'); return; }
      currentUser = v;
      $login.classList.add('hidden');
      $game.classList.remove('hidden');
    }catch(err){ console.error(err); alert('No se pudo iniciar. Revisa la consola.'); }
  }
  $go.addEventListener('click', startGame);
  $nick.addEventListener('keydown', function(e){ if(e.key==='Enter'){ startGame(); } });

  // ——— render banco
  function makeChip(text){
    const el = document.createElement('button');
    el.type = 'button';
    el.className = 'chip';
    el.textContent = text;
    el.dataset.word = text;

    // selección por clic
    el.addEventListener('click', function(){
      const prev = qs('.chip.selected'); if(prev && prev!==el) prev.classList.remove('selected');
      el.classList.toggle('selected');
    });

    enablePointerDrag(el);
    return el;
  }
  // mezclar palabras cada carga
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  shuffle(WORDS.slice()).forEach(w => $bank.appendChild(makeChip(w)));

  // ——— dropzones (click-to-place)
  qsa('.dropzone').forEach(function(z){
    z.addEventListener('click', function(){
      const sel = qs('.chip.selected'); if(!sel) return;
      placeWord(z, sel.dataset.word);
      sel.classList.remove('selected');
    });
  });

  function placeWord(zone, word){
    zone.textContent = word;
    zone.classList.add('filled');
    zone.dataset.user = word;
  }

  // ——— drag por pointer events
  function enablePointerDrag(el){
    let ghost=null;
    el.addEventListener('pointerdown', function(ev){
      ev.preventDefault();
      el.setPointerCapture(ev.pointerId);
      el.classList.add('dragging');

      ghost = el.cloneNode(true);
      ghost.classList.add('ghost');
      ghost.style.left = ev.clientX+'px'; ghost.style.top = ev.clientY+'px';
      document.body.appendChild(ghost);

      function move(e){
        ghost.style.left = e.clientX+'px'; ghost.style.top = e.clientY+'px';
        qsa('.dropzone').forEach(function(d){ d.classList.remove('active'); });
        const under = document.elementFromPoint(e.clientX, e.clientY);
        const dz = under && under.closest ? under.closest('.dropzone') : null;
        if (dz) dz.classList.add('active');
      }
      function up(e){
        el.releasePointerCapture(ev.pointerId);
        el.classList.remove('dragging');
        if (ghost) ghost.remove(); ghost=null;
        qsa('.dropzone').forEach(function(d){ d.classList.remove('active'); });
        const under = document.elementFromPoint(e.clientX, e.clientY);
        const dz = under && under.closest ? under.closest('.dropzone') : null;
        if (dz) placeWord(dz, el.dataset.word);
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        document.removeEventListener('pointercancel', up);
      }
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
      document.addEventListener('pointercancel', up);
    });
  }

  // ——— calificación
  $check.addEventListener('click', function(){
    const zones = qsa('.dropzone');
    var score = 0;
    zones.forEach(function(z){
      z.classList.remove('correct','incorrect');
      var ok = ((z.dataset.user||'').toLowerCase() === (z.dataset.answer||''));
      if (ok){ z.classList.add('correct'); score++; }
      else { z.classList.add('incorrect'); }
    });
    $result.textContent = 'Tu puntaje: ' + score + ' / ' + zones.length;
    storeScore(currentUser, score);
  });

  // ——— almacenamiento / tabla
  function storeScore(nick, score){
    const data = JSON.parse(localStorage.getItem('scores') || '[]');
    data.push({nickname:nick, score:score, at:new Date().toISOString()});
    localStorage.setItem('scores', JSON.stringify(data));
  }
  $tableBtn.addEventListener('click', function(){
    $game.classList.add('hidden'); $scores.classList.remove('hidden');
    $tbody.innerHTML = '';
    const data = JSON.parse(localStorage.getItem('scores') || '[]');
    data.forEach(function(r){
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>'+r.nickname+'</td><td>'+r.score+'</td><td>'+new Date(r.at).toLocaleString()+'</td>';
      $tbody.appendChild(tr);
    });
  });
  $back.addEventListener('click', function(){ $scores.classList.add('hidden'); $game.classList.remove('hidden'); });
  $dl.addEventListener('click', function(){
    const blob = new Blob([localStorage.getItem('scores') || '[]'], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = 'puntajes.json'; a.click(); URL.revokeObjectURL(url);
  });

  // ——— pruebas
  window.testDropzones = function(){ return qsa('.dropzone').length; };
  window.testWords = function(){ return qsa('#bank .chip').length; };
  console.log('Listo ✅  testDropzones(), testWords()');
})();
</script>
</body>
</html>
