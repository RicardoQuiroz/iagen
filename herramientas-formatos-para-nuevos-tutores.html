<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ========= Datos ========= */
  const WORDS = ["abiertas","adaptarlos","personal","acceder","ritmo","reutilizarlos","estilo"];
  let currentUser = null;
  const qs = s => document.querySelector(s);
  const qsa = s => [...document.querySelectorAll(s)];

  /* ========= Login ========= */
  const goBtn = qs('#go');
  const nickInput = qs('#nick');

  function startGame() {
    const v = nickInput.value.trim();
    if (!/^\d+$/.test(v)) {
      alert('Ingresa sólo números.');
      return;
    }
    currentUser = v;
    qs('#login').classList.add('hidden');
    qs('#game').classList.remove('hidden');
  }

  goBtn.addEventListener('click', startGame);
  nickInput.addEventListener('keyup', e => { if (e.key === 'Enter') startGame(); });

  /* ========= Render banco ========= */
  const bank = qs('#bank');
  WORDS.forEach(w => bank.appendChild(makeChip(w)));

  function makeChip(text){
    const el = document.createElement('button');
    el.type = 'button';
    el.className = 'chip';
    el.textContent = text;
    el.dataset.word = text;
    el.addEventListener('click', () => {
      const prev = qs('.chip.selected');
      if (prev && prev !== el) prev.classList.remove('selected');
      el.classList.toggle('selected');
    });
    enablePointerDrag(el);
    return el;
  }

  /* ========= Dropzones ========= */
  qsa('.dropzone').forEach(z => {
    z.addEventListener('click', () => {
      const sel = qs('.chip.selected');
      if (sel) placeWord(z, sel.dataset.word);
    });
  });

  function placeWord(zone, word){
    zone.textContent = word;
    zone.classList.add('filled');
    zone.dataset.user = word;
    const sel = qs('.chip.selected');
    if (sel) sel.classList.remove('selected');
  }

  /* ========= Pointer drag ========= */
  function enablePointerDrag(el){
    let ghost=null;
    el.addEventListener('pointerdown', (ev) => {
      ev.preventDefault();
      el.setPointerCapture(ev.pointerId);
      el.classList.add('dragging');
      ghost = el.cloneNode(true);
      ghost.classList.add('ghost','chip');
      ghost.style.left = ev.clientX + 'px';
      ghost.style.top  = ev.clientY + 'px';
      document.body.appendChild(ghost);
      const move = (e)=>{
        ghost.style.left = e.clientX + 'px';
        ghost.style.top  = e.clientY + 'px';
        qsa('.dropzone').forEach(d => d.classList.remove('active'));
        const under = document.elementFromPoint(e.clientX, e.clientY);
        const dz = under && (under.closest && under.closest('.dropzone'));
        if (dz) dz.classList.add('active');
      };
      const up = (e)=>{
        el.releasePointerCapture(ev.pointerId);
        el.classList.remove('dragging');
        ghost?.remove(); ghost=null;
        qsa('.dropzone').forEach(d => d.classList.remove('active'));
        const under = document.elementFromPoint(e.clientX, e.clientY);
        const dz = under && (under.closest && under.closest('.dropzone'));
        if (dz) placeWord(dz, el.dataset.word);
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', up);
        document.removeEventListener('pointercancel', up);
      };
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', up);
      document.addEventListener('pointercancel', up);
    });
  }

  /* ========= Calificación ========= */
  qs('#check').addEventListener('click', () => {
    const zones = qsa('.dropzone');
    let score = 0;
    zones.forEach(z => {
      z.classList.remove('correct','incorrect');
      const ok = (z.dataset.user || '').trim().toLowerCase() === z.dataset.answer;
      if (ok){ z.classList.add('correct'); score++; }
      else { z.classList.add('incorrect'); }
    });
    const msg = `Tu puntaje: ${score} / ${zones.length}`;
    qs('#result').textContent = msg;
    storeScore(currentUser, score);
  });

  /* ========= Guardado & tabla ========= */
  function storeScore(nick, score){
    const data = JSON.parse(localStorage.getItem('scores') || '[]');
    data.push({nickname:nick, score, at:new Date().toISOString()});
    localStorage.setItem('scores', JSON.stringify(data));
  }

  qs('#tableBtn').addEventListener('click', () => {
    qs('#game').classList.add('hidden');
    qs('#scores').classList.remove('hidden');
    const tbody = qs('#tbody'); tbody.innerHTML = '';
    const data = JSON.parse(localStorage.getItem('scores') || '[]');
    data.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.nickname}</td><td>${r.score}</td><td>${new Date(r.at).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  });

  qs('#back').addEventListener('click', ()=>{
    qs('#scores').classList.add('hidden');
    qs('#game').classList.remove('hidden');
  });

  qs('#dl').addEventListener('click', ()=>{
    const blob = new Blob([localStorage.getItem('scores') || '[]'], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'puntajes.json'; a.click();
    URL.revokeObjectURL(url);
  });

  /* ========= Pruebas ========= */
  window.testDropzones = () => qsa('.dropzone').length;
  window.testWords = () => qsa('#bank .chip').length;
  console.log('%cOK: listeners cargados y botón Comenzar operativo', 'color:green');
});
</script>
